blueprint_name: vertex-ai

vars:
  project_id: earth-clapp  ## Set GCP Project ID Here ##
  deployment_name: vertex-toolkit
  region: us-central1
  share_bucket: bob-share
  scratch_bucket: bob-scratch


deployment_groups:
- group: primary
  modules:
  - id: required_services
    source: ../hpc-toolkit/community/modules/project/service-enablement
    settings:
      gcp_service_list: [
      "compute.googleapis.com",
      "deploymentmanager.googleapis.com",
      "endpoints.googleapis.com",
      "iam.googleapis.com",
      "iamcredentials.googleapis.com",
      "iap.googleapis.com",
      "logging.googleapis.com",
      "monitoring.googleapis.com",
      "networkconnectivity.googleapis.com", 
      "cloudresourcemanager.googleapis.com",
      "oslogin.googleapis.com",
      "pubsub.googleapis.com",
      "storage-api.googleapis.com",
      "storage-component.googleapis.com",
      "storage.googleapis.com",
      "aiplatform.googleapis.com"
    ]

  - id: network1
    use:
    - required_services
    source: ../hpc-toolkit/modules/network/vpc
    settings:
      network_name:  clapp-net
      subnetwork_name:  clapp-sub
  - id: role_bucket
    use:
    - required_services
    source: ./modules/gcp_custom_role
    settings:
      title: "storage-bucket-list"
      role_id: storage_bucket_list
      description: "Custom role with specific storage permissions"
      permissions:
        - storage.buckets.get
        - storage.buckets.list
        - storage.objects.get
        - storage.objects.list
  - id: role_vertex
    use:
    - required_services
    source: ./modules/gcp_custom_role
    settings:
      title: "limited-vertex-controls"
      role_id: limited_vertex_controls
      description: "Vertex pemissions to turn on/off, etc"
      permissions:
        - aiplatform.notebookRuntimes.list
        - aiplatform.notebookRuntimes.start
        - notebooks.instances.start
        - notebooks.instances.stop
  - id: vertex-node-service-account
    use:
    - required_services
    source: ../hpc-toolkit/community/modules/project/service-account
    settings:
      project_id: $(vars.project_id)
      name: instance-acct
      project_roles:
      - iam.serviceAccountUser
      - storage.objectViewer
      - aiplatform.user

  - id: vertex-user-service-account
    use:
    - required_services
    source: ./modules/iam_add_permissions
    settings:
      project_id: $(vars.project_id)
      group_email: "sdss-gcp_sep-storage-vertex-ai@stanford.edu"
      roles:
        browser : roles/browser
        compute_networkViewer: roles/compute.networkViewer
        compute_osLogin: roles/compute.osLogin
        compute_viewer: roles/compute.viewer
        iap_tunnelAccessor: roles/iap.tunnelResourceAccessor
        notebooks_viewer": roles/notebooks.viewer
        serviceAccount_user: roles/iam.serviceAccountUser
        storage_objectViewer: roles/storage.objectViewer
        aiplatform_user: roles/aiplatform.user
        aiplatform_viewer: roles/aiplatform.viewer
        storage_bucket_list: $(role_bucket.id)
        vertex_ai_start: $(role_vertex.id)

  - id: share-bucket
    use:
    - required_services
    source: ./modules/bucket
    settings:
      service_account_email: $(vertex-node-service-account.service_account_email)
      bucket_name: $(vars.share_bucket) 
  - id: scratch-bucket
    use:
    - required_services
    source: ./modules/bucket
    settings:
      service_account_email: $(vertex-node-service-account.service_account_email)
      bucket_name: $(vars.scratch_bucket) 
  
  - id: bob-cpu
    use:
    - network1
    - required_services
    source: ./modules/vertex/cpu
    settings:
      boot_disk_size_gb: 50
      hostname: bob-test-cpu
      machine_type: n1-standard-8
      user: clapp
      image_name: pytorch-latest-gpu-v20230925-debian-11-py310
      service_account_email: $(vertex-node-service-account.service_account_email)
  - id: bob-gpu
    use:
    - network1
    - required_services
    source: ./modules/vertex/gpu
    settings:
      boot_disk_size_gb: 50
      hostname: bob-test-gpu
      machine_type: n1-standard-8
      user: clapp
      image_name: pytorch-latest-gpu-v20230925-debian-11-py310
      service_account_email: $(vertex-node-service-account.service_account_email)
